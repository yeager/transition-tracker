name: Build .deb
on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build .deb
        run: |
          set -e
          NAME="${{ github.event.repository.name }}"
          MODULE="transition_tracker"
          VER=$(grep -oP 'version = "\K[^"]+' pyproject.toml | head -1)
          BUILD="build/${NAME}_${VER}_all"
          mkdir -p "$BUILD/DEBIAN"
          mkdir -p "$BUILD/usr/bin"
          mkdir -p "$BUILD/usr/lib/python3/dist-packages/$MODULE"
          mkdir -p "$BUILD/usr/share/applications"
          mkdir -p "$BUILD/usr/share/locale"

          printf 'Package: %s\nVersion: %s\nArchitecture: all\nMaintainer: Daniel Nylander <daniel@danielnylander.se>\nDepends: python3, python3-gi, gir1.2-gtk-4.0, gir1.2-adw-1\nSection: devel\nPriority: optional\nDescription: %s\n' \
            "$NAME" "$VER" "$NAME" > "$BUILD/DEBIAN/control"

          cp src/$MODULE/*.py "$BUILD/usr/lib/python3/dist-packages/$MODULE/"

          printf '#!/usr/bin/env python3\nfrom %s.main import main\nmain()\n' "$MODULE" > "$BUILD/usr/bin/$NAME"
          chmod +x "$BUILD/usr/bin/$NAME"

          if [ -f "$NAME.desktop" ]; then
            cp "$NAME.desktop" "$BUILD/usr/share/applications/"
          fi

          for po in po/*.po; do
            [ -f "$po" ] || continue
            lang=$(basename "$po" .po)
            mkdir -p "$BUILD/usr/share/locale/$lang/LC_MESSAGES"
            msgfmt "$po" -o "$BUILD/usr/share/locale/$lang/LC_MESSAGES/$NAME.mo" 2>/dev/null || true
          done

          dpkg-deb --root-owner-group --build "$BUILD" "build/${NAME}_${VER}_all.deb"

      - uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: build/*.deb
